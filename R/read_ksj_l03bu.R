#' Kokudosuuchi L03-b-u parser
#' @inheritParams read_ksj_a16
#' @param .meshcode Specific 80km meshcode
#' @param .datum "jgd" or "tky"
#' @description If there is no local file, specify the meshcode to download.
#' @export
read_ksj_l03bu <- function(path = NULL, translate = "jp", .year = NULL, .meshcode = NULL, .datum = NULL, .download = FALSE) {
  if (is.null(path)) {
    dl_zip <-
      zip_l03bu_url(year = .year, meshcode = .meshcode, datum = .datum)
    path <-
      download_ksj_zip(dl_zip, .download = .download, source = "ksj")
  }
  d <-
    st_read_crs4612(path,
                    options = c("ENCODING=CP932"))
  lang <-
    rlang::arg_match(translate,
                   c("raw", "jp", "en"))
  if (lang == "en") {
    d <-
      d %>%
      purrr::set_names(
        c("meshcode_100m", "landuse_class", "day_of_shooting", "geometry"))
  }
  d %>%
    sf::st_transform(crs = 4326) %>%
    sf::st_transform(crs = 6668) %>%
    purrr::modify_at(3,
                     lubridate::as_date)
}

zip_l03bu_url <- function(year, meshcode, datum) {
  jpmesh::is_meshcode(meshcode)
  year <-
    as.character(year)
  year <-
    rlang::arg_match(year,
                     c("2009", "2014", "2016"))
  datum <-
    rlang::arg_match(datum,
                     c("jgd", "tky"))
  if (year == "2009") {
    target_meshes <-
      c("3624", "3725", "3927", "3928", "3942", "4027", "4028", "4042",
      "4128", "4129", "4229", "4530", "4630", "4631", "4730", "4731",
      "4828", "4829", "4830", "4831", "4928", "4929", "4930", "4931",
      "4932", "4933", "4934", "4939", "5029", "5030", "5031", "5032",
      "5033", "5034", "5035", "5036", "5129", "5130", "5131", "5132",
      "5133", "5134", "5135", "5136", "5137", "5138", "5139", "5231",
      "5232", "5233", "5234", "5235", "5236", "5237", "5238", "5239",
      "5240", "5332", "5333", "5334", "5335", "5336", "5337", "5338",
      "5339", "5340", "5433", "5436", "5437", "5438", "5439", "5440",
      "5536", "5537", "5538", "5539", "5540", "5541", "5636", "5637",
      "5638", "5639", "5640", "5641", "5738", "5739", "5740", "5741",
      "5839", "5840", "5841", "5939", "5940", "5941", "6039", "6040",
      "6041", "6140", "6141", "6240", "6241", "6339", "6340", "6341",
      "6342", "6343", "6440", "6441", "6442", "6443", "6444", "6445",
      "6541", "6542", "6543", "6544", "6545", "6641", "6642", "6643",
      "6644", "6742", "6841")
  }
  if (year == "2014") {
    target_meshes <-
      c("3624", "3725", "3927", "3928", "3942", "4027", "4028", "4042",
      "4128", "4129", "4229", "4530", "4630", "4631", "4730", "4731",
      "4828", "4829", "4830", "4831", "4928", "4929", "4930", "4931",
      "4932", "4933", "4934", "4939", "5029", "5030", "5031", "5032",
      "5033", "5034", "5035", "5036", "5129", "5130", "5131", "5132",
      "5133", "5134", "5135", "5136", "5137", "5138", "5139", "5231",
      "5232", "5233", "5234", "5235", "5236", "5237", "5238", "5239",
      "5240", "5332", "5333", "5334", "5335", "5336", "5337", "5338",
      "5339", "5340", "5433", "5436", "5437", "5438", "5439", "5440",
      "5536", "5537", "5538", "5539", "5540", "5541", "5636", "5637",
      "5638", "5639", "5640", "5641", "5738", "5739", "5740", "5741",
      "5839", "5840", "5841", "5939", "5940", "5941", "6039", "6040",
      "6041", "6140", "6141", "6240", "6241", "6339", "6340", "6341",
      "6342", "6343", "6440", "6441", "6442", "6443", "6444", "6445",
      "6541", "6542", "6543", "6544", "6545", "6641", "6642", "6643",
      "6644", "6742", "6841")
  }
  if (year == "2016") {
    target_meshes <-
      c("4630", "4730", "4731", "4828", "4829", "4830", "4831", "4928",
        "4929", "4930", "4931", "4932", "4933", "4934", "5029", "5030",
        "5031", "5032", "5033", "5034", "5035", "5036", "5130", "5131",
        "5132", "5133", "5134", "5135", "5136", "5137", "5138", "5231",
        "5232", "5233", "5234", "5235", "5236", "5237", "5238", "5239",
        "5240", "5332", "5333", "5334", "5335", "5336", "5337", "5338",
        "5339", "5340", "5436", "5437", "5438", "5439", "5440", "5536",
        "5537", "5538", "5539", "5540", "5541", "5636", "5637", "5638",
        "5639", "5640", "5641", "5738", "5739", "5740", "5741", "5839",
        "5840", "5841", "5939", "5940", "6039", "6040")
  }
  if (as.character(meshcode) %in% target_meshes) {
    glue::glue("http://nlftp.mlit.go.jp/ksj/gml/data/{id}/{id}-{yy}/{id}-{yy}_{meshcode}-{datum}_GML.zip",
               id = "L03-b-u",
               yy = substr(year, 3, 4))
  } else {
    rlang::inform(glue::glue("No meshcode was found for the year.
                             Choose one of the following:
                             {candidate_meshes}",
                             candidate_meshes = paste(target_meshes, collapse = ", ")))
  }
}
