#' Kokudosuuchi L03-b parser
#' @inheritParams read_ksj_a16
#' @param .meshcode Specific 80km meshcode
#' @param .datum "jgd" or "tky"
#' @description If there is no local file, specify the meshcode to download.
#' @export
read_ksj_l03b <- function(path = NULL, translate = "jp", .year, .meshcode, .datum, .download = FALSE) {
  if (is.null(path)) {
    dl_zip <-
      zip_l03b_url(year = .year, meshcode = .meshcode, datum = .datum)
    path <-
      download_ksj_zip(dl_zip, .download = .download, source = "ksj")
  }
  d <-
    st_read_crs4612(path,
                    options = c("ENCODING=CP932"))
  lang <-
    rlang::arg_match(translate,
                     c("raw", "jp", "en"))
  if (lang == "en") {
    d <-
      d %>%
      purrr::set_names(
        c("meshcode_100m", "landuse_class", "day_of_shooting", "geometry"))
  }
  d %>%
    sf::st_transform(crs = 4326) %>%
    sf::st_transform(crs = 6668) %>%
    purrr::modify_at(3,
                     lubridate::as_date)
}

zip_l03b_url <- function(year, meshcode, datum) {
  jpmesh::is_meshcode(meshcode)
  year <-
    as.character(year)
  rlang::arg_match(year,
                   c("1976", "1987", "1991", "1997",
                     "2006", "2009", "2014", "2016"))
  datum <-
    rlang::arg_match(datum,
                     c("jgd", "tky"))
  common_meshes <-
    c("4630", "4631", "4729", "4730", "4731", "4828", "4829", "4830",
      "4831", "4928", "4929", "4930", "4931", "4932", "4933", "4934",
      "5029", "5030", "5031", "5032", "5033", "5034", "5035", "5036",
      "5130", "5131", "5132", "5133", "5134", "5135", "5136", "5137",
      "5138", "5231", "5232", "5233", "5234", "5235", "5236", "5237",
      "5238", "5239", "5240", "5332", "5333", "5334", "5335", "5336",
      "5337", "5338", "5339", "5340", "5435", "5436", "5437", "5438",
      "5439", "5440", "5536", "5537", "5538", "5539", "5540", "5541",
      "5636", "5637", "5638", "5639", "5640", "5641", "5738", "5739",
      "5740", "5741", "5839", "5840", "5841", "5939", "5940", "6039",
      "6040", "6041")
  if (!meshcode %in% common_meshes) {
    if (year == "1987") {
      target_meshes <-
        c("3036", "3622", "3623", "3624", "3631", "3641", "3653", "3724",
          "3725", "3741", "3823", "3824", "3831", "3841", "3926", "3927",
          "3928", "3942", "4027", "4028", "4040", "4042", "4128", "4129",
          "4142", "4229", "4230", "4328", "4329", "4429", "4440", "4529",
          "4530", "4531", "4540", "4629", "4728", "4739", "4740", "4839",
          "4939", "5038", "5039", "5129", "5139", "5229", "5432", "5433",
          "5531", "5941", "5942", "6139", "6140", "6141", "6239", "6240",
          "6241", "6243", "6339", "6340", "6341", "6342", "6343", "6439",
          "6440", "6441", "6442", "6443", "6444", "6445", "6540", "6541",
          "6542", "6543", "6544", "6545", "6641", "6642", "6643", "6644",
          "6645", "6741", "6742", "6840", "6841", "6842")
    }
    if (year == "1987") {
      target_meshes <-
        c("3036", "3622", "3623", "3624", "3631", "3641", "3653", "3724",
          "3725", "3741", "3823", "3824", "3831", "3841", "3926", "3927",
          "3928", "3942", "4027", "4028", "4040", "4042", "4128", "4129",
          "4142", "4229", "4230", "4328", "4329", "4429", "4440", "4529",
          "4530", "4531", "4540", "4629", "4728", "4739", "4740", "4839",
          "4939", "5038", "5039", "5129", "5139", "5229", "5432", "5433",
          "5531", "5941", "5942", "6139", "6140", "6141", "6239", "6240",
          "6241", "6243", "6339", "6340", "6341", "6342", "6343", "6439",
          "6440", "6441", "6442", "6443", "6444", "6445", "6540", "6541",
          "6542", "6543", "6544", "6545", "6641", "6642", "6643", "6644",
          "6645", "6741", "6742", "6840", "6841", "6842")
    }
    if (year == "1991") {
      target_meshes <-
        c("3036", "3622", "3623", "3624", "3631", "3641", "3653", "3724",
          "3725", "3741", "3823", "3824", "3831", "3841", "3926", "3927",
          "3928", "3942", "4027", "4028", "4040", "4042", "4128", "4129",
          "4142", "4229", "4230", "4328", "4329", "4429", "4440", "4529",
          "4530", "4531", "4540", "4629", "4728", "4739", "4740", "4839",
          "4939", "5038", "5039", "5129", "5139", "5229", "5432", "5433",
          "5941", "5942", "6139", "6140", "6141", "6239", "6240", "6241",
          "6243", "6339", "6340", "6341", "6342", "6343", "6439", "6440",
          "6441", "6442", "6443", "6444", "6445", "6540", "6541", "6542",
          "6543", "6544", "6545", "6641", "6642", "6643", "6644", "6645",
          "6741", "6742", "6840", "6841", "6842")
    }
    if (year == "1997") {
      target_meshes <-
        c("3036", "3622", "3623", "3624", "3631", "3641", "3653", "3724",
          "3725", "3741", "3823", "3824", "3831", "3841", "3926", "3927",
          "3928", "3942", "4027", "4028", "4040", "4042", "4128", "4129",
          "4142", "4229", "4230", "4328", "4329", "4429", "4440", "4529",
          "4530", "4531", "4540", "4629", "4728", "4739", "4740", "4839",
          "4939", "5038", "5039", "5129", "5139", "5229", "5432", "5433",
          "5941", "5942", "6139", "6140", "6141", "6239", "6240", "6241",
          "6243", "6339", "6340", "6341", "6342", "6343", "6439", "6440",
          "6441", "6442", "6443", "6444", "6445", "6540", "6541", "6542",
          "6543", "6544", "6545", "6641", "6642", "6643", "6644", "6645",
          "6741", "6742", "6840", "6841", "6842")
    }
    if (year == "2006") {
      target_meshes <-
        c("3035", "3036", "3622", "3623", "3624", "3631", "3641", "3653",
          "3724", "3725", "3741", "3823", "3824", "3831", "3841", "3923",
          "3924", "3926", "3927", "3928", "3931", "3941", "3942", "4026",
          "4027", "4028", "4040", "4041", "4042", "4128", "4129", "4140",
          "4141", "4142", "4228", "4229", "4230", "4328", "4329", "4429",
          "4440", "4529", "4530", "4531", "4540", "4629", "4728", "4739",
          "4740", "4827", "4839", "4939", "5038", "5039", "5129", "5139",
          "5229", "5432", "5433", "5531", "5941", "5942", "6139", "6140",
          "6141", "6239", "6240", "6241", "6243", "6339", "6340", "6341",
          "6342", "6343", "6439", "6440", "6441", "6442", "6443", "6444",
          "6445", "6540", "6541", "6542", "6543", "6544", "6545", "6641",
          "6642", "6643", "6644", "6645", "6740", "6741", "6742", "6840",
          "6841", "6842")
    }
    if (year == "2009") {
      target_meshes <-
        c("3036", "3622", "3623", "3624", "3631", "3641", "3653", "3724",
          "3725", "3741", "3823", "3824", "3831", "3841", "3926", "3927",
          "3928", "3942", "4027", "4028", "4040", "4042", "4128", "4129",
          "4142", "4229", "4230", "4328", "4329", "4429", "4440", "4529",
          "4530", "4531", "4540", "4629", "4728", "4739", "4740", "4839",
          "4939", "5038", "5039", "5129", "5139", "5229", "5432", "5433",
          "5531", "5941", "5942", "6139", "6140", "6141", "6239", "6240",
          "6241", "6243", "6339", "6340", "6341", "6342", "6343", "6439",
          "6440", "6441", "6442", "6443", "6444", "6445", "6540", "6541",
          "6542", "6543", "6544", "6545", "6546", "6641", "6642", "6643",
          "6644", "6645", "6646", "6647", "6741", "6742", "6747", "6748",
          "6840", "6841", "6842", "6847", "6848")
    }
    if (year == "2014") {
      target_meshes <-
        c("3036", "3622", "3623", "3624", "3631", "3641", "3653", "3724",
          "3725", "3741", "3823", "3824", "3831", "3841", "3926", "3927",
          "3928", "3942", "4027", "4028", "4040", "4042", "4128", "4129",
          "4142", "4229", "4230", "4328", "4329", "4429", "4440", "4529",
          "4530", "4531", "4540", "4629", "4728", "4739", "4740", "4839",
          "4939", "5038", "5039", "5129", "5139", "5229", "5432", "5433",
          "5531", "5941", "5942", "6139", "6140", "6141", "6239", "6240",
          "6241", "6243", "6339", "6340", "6341", "6342", "6343", "6439",
          "6440", "6441", "6442", "6443", "6444", "6445", "6540", "6541",
          "6542", "6543", "6544", "6545", "6546", "6641", "6642", "6643",
          "6644", "6645", "6646", "6647", "6741", "6742", "6747", "6748",
          "6840", "6841", "6842", "6847", "6848")
    }
    if (year == "2016") {
      target_meshes <-
        common_meshes
    }
    if (!as.character(meshcode) %in% target_meshes) {
      target_meshes <-
        c(common_meshes,
          target_meshes) %>%
        unique() %>%
        sort()
      rlang::inform(glue::glue("No meshcode was found for the year.
                             Choose one of the following:
                             {candidate_meshes}",
                               candidate_meshes = paste(target_meshes,
                                                        collapse = ", ")))
    } else {
      glue::glue("http://nlftp.mlit.go.jp/ksj/gml/data/{id}/{id}-{yy}/{id}-{yy}_{meshcode}-{datum}_GML.zip",
                 id = "L03-b",
                 yy = substr(year, 3, 4))
    }
  } else {
    glue::glue("http://nlftp.mlit.go.jp/ksj/gml/data/{id}/{id}-{yy}/{id}-{yy}_{meshcode}-{datum}_GML.zip",
               id = "L03-b",
               yy = substr(year, 3, 4))
  }
}
